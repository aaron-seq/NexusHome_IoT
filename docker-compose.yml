version: '3.8'

services:
  nexushome-app:
    build:
      context: .
      dockerfile: Dockerfile
      target: final-runtime
    image: nexushome-iot:latest
    container_name: nexushome-app
    restart: unless-stopped
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=${ConnectionStrings__DefaultConnection}
      - ConnectionStrings__Redis=${ConnectionStrings__Redis}
      - MqttBroker__Host=${MqttBroker__Host}
      - MqttBroker__Port=${MqttBroker__Port}
      - MqttBroker__Username=${MqttBroker__Username}
      - MqttBroker__Password=${MqttBroker__Password}
      - JwtAuthentication__SecretKey=${JwtAuthentication__SecretKey}
      - JwtAuthentication__Issuer=${JwtAuthentication__Issuer}
      - JwtAuthentication__Audience=${JwtAuthentication__Audience}
      - WeatherApi__ApiKey=${WEATHER_API_KEY:-}
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt-broker:
        condition: service_healthy
    volumes:
      - app-logs:/application-runtime/logs
      - app-data:/application-runtime/data
      - app-uploads:/application-runtime/uploads
    networks:
      - nexushome-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: nexushome-sqlserver
    restart: unless-stopped
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SQLSERVER_SA_PASSWORD}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - nexushome-net
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P ${SQLSERVER_SA_PASSWORD} -Q 'SELECT 1' -b -o /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: nexushome-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - nexushome-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5
      start_period: 30s

  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: nexushome-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./Configuration/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    networks:
      - nexushome-net
    healthcheck:
      test: ["CMD-SHELL", "timeout 5s mosquitto_sub -h localhost -t '$$SYS/broker/uptime' -C 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  sqlserver-data:
  redis-data:
  mqtt-data:
  mqtt-logs:
  app-logs:
  app-data:
  app-uploads:

networks:
  nexushome-net:
    driver: bridge
